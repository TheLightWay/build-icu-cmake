
#extract ICU sources and build tools
if( NOT EXISTS "${BUILDDIR}/icu" )
    execute_process(
        COMMAND ${CMAKE_COMMAND} -E tar xzf "${DEPOTDIR}/icu4c-src.zip"
        WORKING_DIRECTORY ${BUILDDIR}
    )
endif()

if( NOT EXISTS "${BUILDDIR}/cygwin" )
    file( COPY "${DEPOTDIR}/ConCygSys-installer.cmd" DESTINATION ${BUILDDIR} )
    execute_process(
        COMMAND ConCygSys-installer.cmd
        WORKING_DIRECTORY ${BUILDDIR}
    )
endif()

file( TO_NATIVE_PATH "${BUILDDIR}" BUILDDIR )
set( BUILD_SYS_PATH "${BUILDDIR}\\cygwin\\bin\"" )
string( PREPEND BUILD_SYS_PATH "set \"PATH=%PATH%;" )
set( BUILD_CMD_FILE "${BUILD_ICU_DIR}/build.cmd" )

file( WRITE ${BUILD_CMD_FILE}  "@echo off \n" )
file( APPEND ${BUILD_CMD_FILE} "setlocal \n" )

if( "${CMAKE_CXX_COMPILER_ID}" STREQUAL "MSVC" )
    cmake_do_file( SwitchMSVCVersion.txt )
    set( CONF_ICU "bash runConfigureICU Cygwin/MSVC -prefix=${DIST_DIR} -enable-static -disable-shared ${ICU_WITH_LIB_BITS}" )
elseif( "${CMAKE_CXX_COMPILER_ID}" STREQUAL "GNU" )
    cmake_do_file( SwitchMinGWVersion.txt )
else()
    message( FATAL_ERROR "Compiler curently not supported!" )
endif()

file( APPEND ${BUILD_CMD_FILE} "${BUILD_SYS_PATH} \n" )
file( APPEND ${BUILD_CMD_FILE} "${SETUP_COMPILER} \n" )

file( GLOB DOSTOUNIX_FILES LIST_DIRECTORIES FALSE "${BUILDDIR}/icu/source/*" )
list( LENGTH DOSTOUNIX_FILES D2UF_COUNT )
set( D2UF_INDEX 0 )
set( D2U_FILE "" )
while( D2UF_INDEX LESS D2UF_COUNT )
    list( GET DOSTOUNIX_FILES ${D2UF_INDEX} D2U_FILE )
    get_filename_component( D2U_SHORT_FILE ${D2U_FILE} NAME )
    if( NOT ${D2U_SHORT_FILE} STREQUAL "build.cmd")
        file( APPEND ${BUILD_CMD_FILE} "dos2unix -f ${D2U_SHORT_FILE}\n" )
    endif()
    math( EXPR D2UF_INDEX "${D2UF_INDEX}+1" )
endwhile( )

file( APPEND ${BUILD_CMD_FILE} "${CONF_ICU} \n" )
file( APPEND ${BUILD_CMD_FILE} "make \n" )
file( APPEND ${BUILD_CMD_FILE} "make install \n" )
file( APPEND ${BUILD_CMD_FILE} "exit 0 \n" )

execute_process(
    COMMAND ${BUILD_CMD_FILE} 
    WORKING_DIRECTORY ${BUILD_ICU_DIR}
)



