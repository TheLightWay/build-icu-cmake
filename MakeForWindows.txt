
message( STATUS "Build ICU for Windows")

set( DEPOTDIR "${CMAKE_CURRENT_LIST_DIR}/filedepot/win")

#extract ICU sources and build tools
if( NOT EXISTS "${BUILDDIR}/icu" )
    execute_process(
        COMMAND ${CMAKE_COMMAND} -E tar xzf "${DEPOTDIR}/icu4c-src.zip"
        WORKING_DIRECTORY ${BUILDDIR}
    )
endif()

if( NOT EXISTS "${BUILDDIR}/cygwin" )
    file( COPY "${DEPOTDIR}/ConCygSys-installer.cmd" DESTINATION ${BUILDDIR} )
    execute_process(
        COMMAND ConCygSys-installer.cmd
        WORKING_DIRECTORY ${BUILDDIR}
    )
endif()

file( TO_NATIVE_PATH "${BUILDDIR}" BUILDDIR )
set( BUILD_SYS_PATH "${BUILDDIR}\\cygwin\\bin\"" )
string( PREPEND BUILD_SYS_PATH "set \"PATH=%PATH%;" )
set( BUILD_CMD_FILE "${BUILD_ICU_DIR}/build.cmd" )

file( WRITE ${BUILD_CMD_FILE}  "@echo off \n" )
file( APPEND ${BUILD_CMD_FILE} "setlocal \n" )

if( "${CMAKE_CXX_COMPILER_ID}" STREQUAL "MSVC" )
    if( MSVC_TOOLSET_VERSION EQUAL 141 )
        include( ${CMAKE_CURRENT_LIST_DIR}/MakeForMSVC17.txt )
    else()
        message( FATAL_ERROR "Need implement build script for this MSVC version" )
    endif()
    set( CONF_ICU "bash runConfigureICU Cygwin/MSVC -prefix=${DIST_DIR} -enable-static -disable-shared ${ICU_WITH_LIB_BITS}" )
    file( APPEND ${BUILD_CMD_FILE} "${BUILD_SYS_PATH} \n" )
    file( APPEND ${BUILD_CMD_FILE} "${VSVARSALL_BAT} \n" )
elseif( "${CMAKE_CXX_COMPILER_ID}" STREQUAL "GNU" )
    message( FATAL_ERROR "Not impl for GNU compiler")
else()
    message( FATAL_ERROR "Compiler curently not supported!" )
endif()

#add compiler independent build script commands
file( APPEND ${BUILD_CMD_FILE} "dos2unix *\n" )
file( APPEND ${BUILD_CMD_FILE} "REM After asterisk\n" )
file( APPEND ${BUILD_CMD_FILE} "dos2unix -f configure\n" )
file( APPEND ${BUILD_CMD_FILE} "${CONF_ICU} \n" )
file( APPEND ${BUILD_CMD_FILE} "make \n" )
file( APPEND ${BUILD_CMD_FILE} "make install \n" )
file( APPEND ${BUILD_CMD_FILE} "exit 0 \n" )

execute_process(
    COMMAND ${BUILD_CMD_FILE} 
    WORKING_DIRECTORY ${BUILD_ICU_DIR}
)



